stages:
  - build
  - push

variables:
  IMAGE_NAME: "apim-apigeelint"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"  # commit-based tag for reproducibility
  NEXUS_REGISTRY: "fmk.nexus-ci.onefiserv.net"
  NEXUS_REPO_USER: "svc-apim-cicd-dev"
  NEXUS_REPO_PASS: "xxxxxxxxxx"  # store securely in GitLab CI/CD variables

build_image:
  stage: build
  script:
    - echo "Building Docker image with tag: $IMAGE_TAG"
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
  only:
    - main
    - master
    - test

push_image:
  stage: push
  script:
    - echo "Logging into Nexus..."
    - echo $NEXUS_REPO_PASS | docker login $NEXUS_REGISTRY -u $NEXUS_REPO_USER --password-stdin
    - echo "Tagging image with commit SHA tag..."
    - docker tag $IMAGE_NAME:$IMAGE_TAG $NEXUS_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
    - echo "Pushing image to Nexus with commit tag: $IMAGE_TAG"
    - docker push $NEXUS_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
  only:
    - main
    - master
    - test
  needs:
    - build_image